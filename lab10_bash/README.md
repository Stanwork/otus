## BASH


Домашнее задание
	
Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:

1. Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
2. Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
3. Ошибки веб-сервера/приложения c момента последнего запуска;
4. Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.
5. Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.
	
В письме должен быть прописан обрабатываемый временной диапазон.

Исходный лог файл: [access-4560-644067.log.txt](access-4560-644067.log.txt)	

[lines](./lines) - файл в который записывается последняя доступная строка, при след. запуске файл будет парситься со след. строки, указанной в файле.


Начнем с выбора нужной информации

### 1. Топ 10 IP адресов с наибольшим кол-вом запросов:

```
$ awk '{print $1}' access-4560-644067.log.txt | sort | uniq -c | sort -rn | awk '{ if ( $1 >= 0 ) { print "Количество запросов:" $1, "IP:" $2 } }' | head -n 10
Количество запросов:45 IP:93.158.167.130
Количество запросов:39 IP:109.236.252.130
Количество запросов:37 IP:212.57.117.19
Количество запросов:33 IP:188.43.241.106
Количество запросов:31 IP:87.250.233.68
Количество запросов:24 IP:62.75.198.172
Количество запросов:22 IP:148.251.223.21
Количество запросов:20 IP:185.6.8.9
Количество запросов:17 IP:217.118.66.161
Количество запросов:16 IP:95.165.18.146
```	

### 2. Вывод списка ссылок в том числе с пустыми запросами:
```
awk '{print $11}' access-4560-644067.log.txt|sort|uniq -c|sort -rn|awk '{ if ( $1 >= 10 ) { print "Количество запросов:" $1, "URL:" $2 } }'
Количество запросов:498 URL:"-"
Количество запросов:73 URL:"https://dbadmins.ru/"
Количество запросов:15 URL:"https://dbadmins.ru/2016/10/26/%D0%B8%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D1%85-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BA-%D0%B4%D0%BB%D1%8F-oracle-rac/"
Количество запросов:14 URL:"https://dbadmins.ru/2016/10/17/%D0%9F%D1%80%D0%BE%D0%B4%D0%BE%D0%BB%D0%B6%D0%B0%D0%B5%D0%BC-%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D0%B8%D0%BC%D0%B5%D0%BD%D1%82%D1%8B-%D1%81-lacp/"
Количество запросов:11 URL:uct="-"

```
	
### 3. Ошибки в errorlog

```
cat access-4560-644067.log.txt | cut -d '"' -f3 | cut -d ' ' -f2 | grep -vE '[23]0[0-9]' | sort | uniq -c | sort -rn
     51 404
     18 400
      3 500
      2 499
      1 405
      1 403
```
	
### 4. Список всех кодов HTTP ответа с указанием их кол-ва
```
cat access-4560-644067.log.txt  | cut -d " " -f 9 | sort -n | uniq -c -d | sort -nr
    498 200
     95 301
     51 404
     11 "-"
      7 400
      3 500
      2 499
```
### 5. Скрипт парсера: [logparser.sh](./logparser.sh)	
Запуск скрипта через CRON каждый час с запретом одновременного запуска неск. копий с использованием flock:
``` 
0 */1 * * * root /usr/bin/flock -w 600 /var/tmp/logparser.lock /root/logparser.sh
```

Результат выполнения скрипта записывается в файл отчета вида: [Report_2023-06-04_14:51.txt](./Report_2023-06-04_14%3A51.txt)
Затем отправляется с помощью sendmail на почту.
